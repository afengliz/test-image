apiVersion: v1
kind: Pod
metadata:
  name: buildah-demo-no-sysadmin
  namespace: imgbuild
  labels:
    app: buildah-demo-no-sysadmin
spec:
  restartPolicy: Never
  containers:
    - name: buildah-demo
      # 使用 Buildah 官方镜像
      image: quay.io/buildah/stable:latest
      # 保持容器运行，等待手动触发
      command: ["/bin/sh", "-c"]
      args:
        - |
          echo "容器已启动，等待文件复制..."
          echo "文件复制完成后，请执行: kubectl -n imgbuild exec buildah-demo-no-sysadmin -- /workspace/main"
          # 配置 rootless 模式（使用 fuse-overlayfs）
          mkdir -p /root/.config/containers
          echo '[storage]' > /root/.config/containers/storage.conf
          echo 'driver = "overlay"' >> /root/.config/containers/storage.conf
          echo '[storage.options]' >> /root/.config/containers/storage.conf
          echo 'mount_program = "/usr/bin/fuse-overlayfs"' >> /root/.config/containers/storage.conf
          # 保持容器运行
          tail -f /dev/null
      volumeMounts:
        - name: workspace
          mountPath: /workspace
      # Rootless 模式配置（不使用 SYS_ADMIN）
      securityContext:
        allowPrivilegeEscalation: false
        # 不添加 SYS_ADMIN，依赖 fuse-overlayfs
      resources:
        requests:
          memory: "1Gi"
          cpu: "500m"
        limits:
          memory: "2Gi"
          cpu: "1000m"
  volumes:
    - name: workspace
      emptyDir: {}
  # 注意：K8s 中无法直接挂载 /dev/fuse，需要通过 hostPath volume
  # 但 hostPath 挂载设备需要 privileged 或 SYS_ADMIN
  # 所以真正的 rootless 模式在 K8s 中可能需要 privileged: true
  # 或者使用 vfs 存储驱动（不需要挂载，但性能较差）

