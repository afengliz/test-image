# åœ¨ Go ç¨‹åºä¸­æ„å»º Docker é•œåƒ

## åŠŸèƒ½è¯´æ˜

è¿™ä¸ªç¨‹åºå¯ä»¥ï¼š
1. âœ… **è‡ªåŠ¨æ‹‰å–åŸºç¡€é•œåƒ**ï¼ˆå¦‚ `golang:1.20-alpine`ï¼‰
2. âœ… **å°† server æ–‡ä»¶å¤¹çš„æ‰€æœ‰æ–‡ä»¶å¤åˆ¶åˆ°é•œåƒçš„ `/usr/local/app` ç›®å½•**
3. âœ… **è®¾ç½® `/usr/local/app` ä¸ºå·¥ä½œç›®å½•ï¼ˆWORKDIRï¼‰**
4. âœ… **åŠ¨æ€ç”Ÿæˆ Dockerfile å¹¶æ„å»ºé•œåƒ**

## å‰ç½®è¦æ±‚

### æ–¹å¼1: Docker SDKï¼ˆé»˜è®¤ï¼Œéœ€è¦ Docker å®ˆæŠ¤è¿›ç¨‹ï¼‰
- âœ… **éœ€è¦ Docker å®ˆæŠ¤è¿›ç¨‹è¿è¡Œ**
- å®‰è£…ä¾èµ–ï¼š
  ```bash
  cd ones-platform-api/test_image/image
  go mod tidy
  ```

### æ–¹å¼2: Buildahï¼ˆæ— éœ€ Docker å®ˆæŠ¤è¿›ç¨‹ï¼‰â­ æ¨è
- âŒ **ä¸éœ€è¦ Docker å®ˆæŠ¤è¿›ç¨‹**
- âœ… éœ€è¦å®‰è£… buildahï¼š
  ```bash
  brew install buildah  # macOS
  # æˆ–
  apt-get install buildah  # Linux
  ```

### æ–¹å¼3: Kanikoï¼ˆæ— éœ€ Docker å®ˆæŠ¤è¿›ç¨‹ï¼‰
- âŒ **ä¸éœ€è¦ Docker å®ˆæŠ¤è¿›ç¨‹**
- âš ï¸ éœ€è¦å®¹å™¨è¿è¡Œæ—¶ï¼ˆå¦‚ Dockerã€Podmanï¼‰æ¥è¿è¡Œ kaniko å®¹å™¨

## ä½¿ç”¨æ–¹å¼

### 1. å®‰è£…ä¾èµ–
```bash
cd ones-platform-api/test_image/image
go mod tidy
```

### 2. é…ç½®å‚æ•°ï¼ˆåœ¨ main.go ä¸­ï¼‰
```go
baseImage := "golang:1.20-alpine"  // åŸºç¡€é•œåƒ
imageName := "my-app:latest"         // æ„å»ºçš„é•œåƒåç§°
serverPath := "../server"            // server æ–‡ä»¶å¤¹è·¯å¾„
```

### 3. è¿è¡Œç¨‹åº

#### ä½¿ç”¨ Docker SDKï¼ˆé»˜è®¤ï¼Œéœ€è¦ Dockerï¼‰
```bash
go run main.go
# æˆ–
BUILD_MODE=docker go run main.go
```

#### ä½¿ç”¨ Buildahï¼ˆæ— éœ€ Docker å®ˆæŠ¤è¿›ç¨‹ï¼‰â­ æ¨è
```bash
BUILD_MODE=buildah go run main.go
```

#### ä½¿ç”¨ Kanikoï¼ˆæ— éœ€ Docker å®ˆæŠ¤è¿›ç¨‹ï¼‰
```bash
BUILD_MODE=kaniko go run main.go
```

## å·¥ä½œæµç¨‹

1. **æ‹‰å–åŸºç¡€é•œåƒ** - ä» Docker Hub æ‹‰å–æŒ‡å®šçš„åŸºç¡€é•œåƒ
2. **ç”Ÿæˆ Dockerfile** - åŠ¨æ€ç”ŸæˆåŒ…å«ä»¥ä¸‹å†…å®¹çš„ Dockerfileï¼š
   ```dockerfile
   FROM <åŸºç¡€é•œåƒ>
   WORKDIR /usr/local/app
   COPY server/ /usr/local/app/
   WORKDIR /usr/local/app
   ```
3. **åˆ›å»ºæ„å»ºä¸Šä¸‹æ–‡** - å°† Dockerfile å’Œ server æ–‡ä»¶å¤¹æ‰“åŒ…æˆ tar æ–‡ä»¶
4. **æ„å»ºé•œåƒ** - ä½¿ç”¨ Docker SDK æ„å»ºé•œåƒ

## ç”Ÿæˆçš„é•œåƒç»“æ„

```
é•œåƒå†…å®¹:
â”œâ”€â”€ /usr/local/app/          (å·¥ä½œç›®å½•)
â”‚   â”œâ”€â”€ main.go
â”‚   â”œâ”€â”€ go.mod
â”‚   â””â”€â”€ main (å¦‚æœæœ‰ç¼–è¯‘åçš„äºŒè¿›åˆ¶æ–‡ä»¶)
```

## ä»£ç è¯´æ˜

- **pullBaseImage**: æ‹‰å–åŸºç¡€é•œåƒ
- **generateDockerfile**: ç”Ÿæˆ Dockerfile å†…å®¹
- **createBuildContext**: åˆ›å»ºåŒ…å« Dockerfile å’Œ server æ–‡ä»¶çš„æ„å»ºä¸Šä¸‹æ–‡
- **buildImageWithServer**: å®Œæ•´çš„æ„å»ºæµç¨‹ï¼ˆæ‹‰å–é•œåƒ + æ„å»ºï¼‰

## æ€»ç»“

### åœ¨ç¨‹åºé‡Œåˆ¶ä½œé•œåƒæ˜¯å¦éœ€è¦ Dockerï¼Ÿ

ç­”æ¡ˆï¼š**å–å†³äºé€‰æ‹©çš„æ„å»ºæ–¹å¼**

| æ„å»ºæ–¹å¼ | éœ€è¦ Docker å®ˆæŠ¤è¿›ç¨‹ï¼Ÿ | éœ€è¦å®‰è£…ä»€ä¹ˆï¼Ÿ |
|---------|---------------------|--------------|
| **Docker SDK**ï¼ˆé»˜è®¤ï¼‰ | âœ… **æ˜¯** | Docker å®ˆæŠ¤è¿›ç¨‹ |
| **Buildah** | âŒ **å¦** | buildah å·¥å…· |
| **Kaniko** | âŒ **å¦** | å®¹å™¨è¿è¡Œæ—¶ï¼ˆç”¨äºè¿è¡Œ kaniko å®¹å™¨ï¼‰ |

### æ¨èæ–¹æ¡ˆ

- **æœ‰ Docker ç¯å¢ƒ**ï¼šä½¿ç”¨é»˜è®¤çš„ Docker SDK æ–¹å¼
- **æ—  Docker ç¯å¢ƒ**ï¼šä½¿ç”¨ **Buildah** æ–¹å¼ï¼ˆ`BUILD_MODE=buildah`ï¼‰
  ```bash
  # å®‰è£… buildah
  brew install buildah  # macOS
  
  # ä½¿ç”¨ buildah æ„å»º
  BUILD_MODE=buildah go run main.go
  ```

### å„æ–¹å¼å¯¹æ¯”

| ç‰¹æ€§ | Docker SDK | Buildah | Kaniko |
|-----|-----------|---------|--------|
| **èµ„æºå ç”¨** | ğŸ”´ é‡ï¼ˆéœ€è¦å®ˆæŠ¤è¿›ç¨‹ï¼‰ | ğŸŸ¢ è½»ï¼ˆæ— éœ€å®ˆæŠ¤è¿›ç¨‹ï¼‰ | ğŸŸ¡ ä¸­ï¼ˆéœ€è¦å®¹å™¨è¿è¡Œæ—¶ï¼‰ |
| **å†…å­˜å ç”¨** | ~200-500MBï¼ˆå®ˆæŠ¤è¿›ç¨‹ï¼‰ | ~50-100MB | ~100-200MBï¼ˆå®¹å™¨ï¼‰ |
| **å¯åŠ¨é€Ÿåº¦** | æ…¢ï¼ˆéœ€è¦å¯åŠ¨å®ˆæŠ¤è¿›ç¨‹ï¼‰ | å¿«ï¼ˆç›´æ¥æ‰§è¡Œå‘½ä»¤ï¼‰ | ä¸­ï¼ˆéœ€è¦æ‹‰å–å®¹å™¨é•œåƒï¼‰ |
| **ä¾èµ–** | Docker å®ˆæŠ¤è¿›ç¨‹ | buildah å·¥å…· | å®¹å™¨è¿è¡Œæ—¶ + kaniko é•œåƒ |
| **æƒé™è¦æ±‚** | éœ€è¦ root æˆ– docker ç»„ | æ”¯æŒ rootless | éœ€è¦å®¹å™¨è¿è¡Œæ—¶æƒé™ |
| **é€‚ç”¨åœºæ™¯** | å¼€å‘ç¯å¢ƒã€æœ¬åœ°æ„å»º | CI/CDã€ç”Ÿäº§ç¯å¢ƒ | Kubernetes é›†ç¾¤ |

### è½»é‡ç¨‹åº¦æ’å

1. ğŸŸ¢ **Buildah - æœ€è½»é‡**
   - âœ… æ— éœ€å®ˆæŠ¤è¿›ç¨‹
   - âœ… èµ„æºå ç”¨æœ€å°ï¼ˆ~50-100MBï¼‰
   - âœ… å¯åŠ¨æœ€å¿«
   - âœ… æ”¯æŒ rootless æ¨¡å¼
   - âš ï¸ éœ€è¦å®‰è£… buildah å·¥å…·

2. ğŸŸ¡ **Kaniko - ä¸­ç­‰**
   - âœ… æ— éœ€ Docker å®ˆæŠ¤è¿›ç¨‹
   - âš ï¸ éœ€è¦å®¹å™¨è¿è¡Œæ—¶ï¼ˆDocker/Podmanï¼‰æ¥è¿è¡Œå®¹å™¨
   - âš ï¸ éœ€è¦æ‹‰å– kaniko é•œåƒï¼ˆ~100MB+ï¼‰
   - âœ… é€‚åˆ Kubernetes ç¯å¢ƒ

3. ğŸ”´ **Docker SDK - æœ€é‡**
   - âŒ éœ€è¦ Docker å®ˆæŠ¤è¿›ç¨‹ï¼ˆå¸¸é©»è¿›ç¨‹ï¼‰
   - âŒ å†…å­˜å ç”¨å¤§ï¼ˆ~200-500MBï¼‰
   - âŒ å¯åŠ¨æ…¢ï¼ˆéœ€è¦å…ˆå¯åŠ¨å®ˆæŠ¤è¿›ç¨‹ï¼‰
   - âœ… åŠŸèƒ½æœ€å®Œæ•´
   - âœ… ä½¿ç”¨æœ€å¹¿æ³›

### æ¨èé€‰æ‹©

- **è¿½æ±‚è½»é‡çº§**ï¼šğŸ‘‰ **Buildah**ï¼ˆ`BUILD_MODE=buildah`ï¼‰
- **æœ‰ Docker ç¯å¢ƒ**ï¼šğŸ‘‰ Docker SDKï¼ˆé»˜è®¤ï¼‰
- **Kubernetes ç¯å¢ƒ**ï¼šğŸ‘‰ Kanikoï¼ˆ`BUILD_MODE=kaniko`ï¼‰

